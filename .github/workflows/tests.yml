name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Print runner info
        run: |
          python -c "import platform; print(f'OS: {platform.system()} {platform.machine()}')"
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sysctl -n machdep.cpu.brand_string || echo "Unknown CPU"
          else
            cat /proc/cpuinfo | grep "model name" | head -1 || echo "Unknown CPU"
          fi
          python -c "import os; print(f'CPU count: {os.cpu_count()}')"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          source .venv/bin/activate
          python -m pytest tests/ -v --tb=short

  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Test framework imports
        run: |
          source .venv/bin/activate
          python -c "
          from cotlab import __version__
          from cotlab.backends import TransformersBackend
          from cotlab.experiments import (
              CoTFaithfulnessExperiment,
              RadiologyExperiment,
              CoTAblationExperiment,
              ActivationPatchingExperiment,
              SycophancyHeadsExperiment,
              MultiHeadPatchingExperiment,
              FullLayerPatchingExperiment,
              SteeringVectorsExperiment,
              CoTHeadsExperiment,
              LogitLensExperiment,
              MultiHeadCoTExperiment,
          )
          from cotlab.prompts import ChainOfThoughtStrategy, RadiologyPromptStrategy
          from cotlab.datasets import RadiologyDataset, SyntheticMedicalDataset
          from cotlab.analysis import CoTParser, FaithfulnessMetrics
          from cotlab.patching import ActivationPatcher

          print(f'CoTLab v{__version__} - All 12 experiments available!')
          "

      - name: Test prompt strategies
        run: |
          source .venv/bin/activate
          python -c "
          from cotlab.prompts import create_prompt_strategy

          strategies = [
              'simple', 'chain_of_thought', 'direct_answer', 'arrogance', 'no_instruction',
              'adversarial', 'uncertainty', 'socratic', 'contrarian', 'expert_persona',
              'sycophantic', 'few_shot'
          ]
          for name in strategies:
              s = create_prompt_strategy(name)
              prompt = s.build_prompt({'question': 'Test question?'})
              print(f'{name}: {len(prompt)} chars')

          print(f'All {len(strategies)} prompt strategies work!')
          "

      - name: Test dataset loading
        run: |
          source .venv/bin/activate
          python -c "
          from cotlab.datasets import SyntheticMedicalDataset, RadiologyDataset

          synthetic = SyntheticMedicalDataset()
          print(f'Synthetic dataset: {len(synthetic)} samples')

          radiology = RadiologyDataset()
          print(f'Radiology dataset: {len(radiology)} samples')

          print('All datasets load correctly!')
          "

      - name: Test CoT parser
        run: |
          source .venv/bin/activate
          python -c "
          from cotlab.analysis import CoTParser

          parser = CoTParser()
          cot = '''
          1. Patient has fever
          2. Symptoms suggest infection
          Therefore, likely viral URI.
          '''

          result = parser.analyze(cot)
          print(f'Steps: {result[\"num_steps\"]}')
          print(f'Conclusion: {result[\"conclusion\"]}')
          print('CoT parser works!')
          "

  notebook-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]" jupyter nbconvert

      - name: Execute tutorial notebook
        run: |
          source .venv/bin/activate
          jupyter nbconvert --to notebook --execute notebooks/cotlab_tutorial.ipynb --output executed_tutorial.ipynb
          echo "Notebook executed successfully on ${{ matrix.os }}!"
